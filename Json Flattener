#First the flatten_json package needs to be installed.
from json import load
from csv import writer
from os import listdir
import pandas as pd
from flatten_json import flatten
import re

# Read files with university data.
lists = listdir("/Users/jesusllanogarcia/Desktop/Projecto/Scival")
data = [[] for i in range(len(lists))]
for i in range(len(lists)):
    with open("/Users/jesusllanogarcia/Desktop/Projecto/Scival/%s" % lists[i], "r") as read_file:
        data[i] = load(read_file)

# Create a file in which to save the processed data.
universities_csv = open('/Users/jesusllanogarcia/Desktop/Projecto/universities_data.csv', 'w')
csvwriter = writer(universities_csv)

# Transform the json into a flat arrange (dic_flattened) so it can be easily transformed into a dataframe (df).
dic_flattened = (flatten(d) for d in data)

df = pd.DataFrame(dic_flattened)

df = df.drop(['uri'], axis=1)

#save the headers in a variable as a list.
names = list(df.columns)
names2 = list(names)

# obtain the type of metric that correspond with each column and save it (new).
new = []
for i in range(11):
    for j in range(len(names)):
        if 'metrics_%d_metricType' % i in names[j]:
            new.append(df.at[0, names[j]])

# Change the names so they include the metric.
for i in range(11):
    for j in range(len(names)):
        if 'metrics_%d_' % i in names[j]:
            names[j] = names[j].replace('metrics_%d_' % i, new[i] + '_')

# Rename the colums of the table accordingly to the type of Metric.
for i in range(len(names)):
    df = df.rename(columns={names2[i]: names[i]})

for name in new:
    df = df.drop(['{}_metricType'.format(name)], axis=1)

names = list(df.columns)
print(names)
count = 0

new2 = []
for name in new:
    for j in range(4,len(names)):
        if '{}_values_'.format(name) and not'ByYear' in names[j]:
            count +=1
            value = df.at[0, names[j]]
            value = str(value)
            value = value.replace('Academic-corporate collaboration','ACC')
            print(value)
            print('{}_values_'.format(name))
            names[j] = re.sub(r'values_.', value, names[j])

print(len(new2))
print(new2)
print(count)


#df.to_csv('/Users/jesusllanogarcia/Desktop/Projecto/universities_data-uri2.csv')
